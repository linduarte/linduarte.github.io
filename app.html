<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Entrando...</title>
  <script>
    // Client-side token validation: parse a JWT in localStorage.access_token and check `exp` claim.
    // If expired, show a small UI to let the user login or attempt a refresh using a `refresh_token`.
    (function () {
      function base64UrlDecode(input) {
        // Replace url-safe chars and add padding
        input = input.replace(/-/g, '+').replace(/_/g, '/');
        const pad = input.length % 4;
        if (pad === 2) input += '==';
        else if (pad === 3) input += '=';
        else if (pad !== 0) return null;
        try {
          return decodeURIComponent(escape(atob(input)));
        } catch (e) {
          try {
            return atob(input);
          } catch (e2) {
            return null;
          }
        }
      }

      function parseJwt(token) {
        if (!token) return null;
        const parts = token.split('.');
        if (parts.length < 2) return null;
        const payload = base64UrlDecode(parts[1]);
        if (!payload) return null;
        try {
          return JSON.parse(payload);
        } catch (e) {
          return null;
        }
      }

      // Read optional expected audience/issuer from meta tags.
      // If not provided, checks that depend on them are permissive.
      const expectedAud = (document.querySelector('meta[name="jwt-aud"]') || {}).content || null;
      const expectedIss = (document.querySelector('meta[name="jwt-iss"]') || {}).content || null;

      function isTokenValid(token) {
        const payload = parseJwt(token);
        if (!payload) return false;
        const now = Math.floor(Date.now() / 1000);

        // nbf: not-before (optional). If present, ensure token is usable now (5s leeway).
        if (payload.nbf && typeof payload.nbf === 'number') {
          if (now + 5 < payload.nbf) return false;
        }

        // exp: expiry (recommended). If present, ensure not expired.
        if (payload.exp && typeof payload.exp === 'number') {
          if (!(payload.exp > now + 5)) return false; // expired or about to expire
        } else {
          // No exp claim: consider it invalid (safer)
          return false;
        }

        // aud: audience (optional). Only enforce when both the token has `aud`
        // and an expected audience is configured via meta tag. If the token
        // lacks aud, default to permissive behavior.
        if (payload.aud && expectedAud) {
          if (Array.isArray(payload.aud)) {
            if (payload.aud.indexOf(expectedAud) === -1) return false;
          } else {
            if (payload.aud !== expectedAud) return false;
          }
        }

        // iss: issuer (optional). Only enforce when both present and expected.
        if (payload.iss && expectedIss) {
          if (payload.iss !== expectedIss) return false;
        }

        return true;
      }

      function renderExpiredUI(hasRefresh) {
        document.body.innerHTML = '';
        const container = document.createElement('div');
        container.setAttribute('role', 'dialog');
        container.setAttribute('aria-modal', 'true');
        container.style.outline = 'none';
        container.style.fontFamily = 'Arial, sans-serif';
        container.style.maxWidth = '520px';
        container.style.margin = '10vh auto';
        container.style.padding = '20px';
        container.style.border = '1px solid #e6e6e6';
        container.style.borderRadius = '6px';
        container.style.textAlign = 'center';

  const h = document.createElement('h2');
  h.textContent = 'Sessão expirada';
  h.id = 'expired-title';
  container.setAttribute('aria-labelledby', h.id);
        container.appendChild(h);

        const p = document.createElement('p');
        p.textContent = 'Sua sessão expirou. Faça login para continuar ou tente renovar o token se disponível.';
        container.appendChild(p);

        const btnLogin = document.createElement('button');
        btnLogin.textContent = 'Login';
        btnLogin.style.margin = '8px';
  btnLogin.onclick = function () { window.location.href = '/app/templates/git-course/login.html'; };
  btnLogin.setAttribute('aria-label', 'Fazer login');
  btnLogin.addEventListener('keydown', e => { if (e.key === 'Enter') btnLogin.click(); });
        container.appendChild(btnLogin);

        if (hasRefresh) {
          const btnRefresh = document.createElement('button');
          btnRefresh.textContent = 'Tentar renovar token';
          btnRefresh.style.margin = '8px';
          btnRefresh.setAttribute('aria-label', 'Tentar renovar token');
          btnRefresh.addEventListener('keydown', e => { if (e.key === 'Enter') btnRefresh.click(); });
          btnRefresh.onclick = function () {
            // show spinner on the button and attempt refresh (non-silent)
            btnRefresh.disabled = true;
            const originalText = btnRefresh.textContent;
            btnRefresh.innerHTML = '<span class="spinner" aria-hidden="true" style="display:inline-block;vertical-align:middle;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;margin-right:6px;animation:spin 0.8s linear infinite"></span>Tentando...';
            attemptRefresh(false).then(() => {
              // no-op: attemptRefresh will redirect on success; on failure we restore button
            }).catch(() => {
              btnRefresh.disabled = false;
              btnRefresh.textContent = originalText;
            });
          };
          container.appendChild(btnRefresh);
        }

        // toast / live region for status messages
        const toast = document.createElement('div');
        toast.id = 'refresh-toast';
        toast.setAttribute('role', 'status');
        toast.setAttribute('aria-live', 'polite');
        toast.style.position = 'fixed';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.bottom = '18px';
        toast.style.minWidth = '220px';
        toast.style.padding = '10px 14px';
        toast.style.background = 'rgba(0,0,0,0.85)';
        toast.style.color = '#fff';
        toast.style.borderRadius = '8px';
        toast.style.display = 'none';
        toast.style.zIndex = '1000';
        document.body.appendChild(toast);

        const note = document.createElement('p');
        note.style.marginTop = '12px';
        note.style.fontSize = '13px';
        note.style.color = '#666';
        note.textContent = 'Se a renovação falhar, faça login novamente.';
        container.appendChild(note);

        document.body.appendChild(container);
        // focus the first interactive element for keyboard users
        setTimeout(() => {
          const focusable = container.querySelector('button');
          if (focusable) focusable.focus();
        }, 0);
      }

      // helper to show a small accessible toast with optional spinner
      function showToast(message, { spinner = false, timeout = 4000 } = {}) {
        const toast = document.getElementById('refresh-toast');
        if (!toast) return;
        toast.innerHTML = (spinner ? '<span class="spinner" aria-hidden="true" style="display:inline-block;vertical-align:middle;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;margin-right:8px;animation:spin 0.8s linear infinite"></span>' : '') + '<span>' + message + '</span>';
        toast.style.display = 'block';
        if (timeout > 0) setTimeout(() => { toast.style.display = 'none'; }, timeout);
      }

      // spinner keyframes
      const styleEl = document.createElement('style');
      styleEl.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(styleEl);

      async function attemptRefresh(silent = false) {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) return false;
        try {
          // If silent, announce that we're attempting a refresh
          if (silent) showToast('Tentando renovar...', { spinner: true, timeout: 0 });
          // Example refresh endpoint — your backend would need to provide this.
          const resp = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken })
          });

          if (!resp.ok) throw new Error('refresh-failed');
          const data = await resp.json();
          if (data && data.access_token) {
            localStorage.setItem('access_token', data.access_token);
            if (data.refresh_token) localStorage.setItem('refresh_token', data.refresh_token);
            // Announce success and redirect to prefácio
            if (silent) showToast('Renovado', { spinner: false, timeout: 1500 });
            window.location.replace('/app/templates/git-course/1a-prefacio.html');
            return true;
          }
          return false;
        } catch (e) {
          // Refresh failed — either fail silently or fall back to login
          try { localStorage.removeItem('access_token'); } catch (__) {}
          try { localStorage.removeItem('refresh_token'); } catch (__) {}
          if (silent) {
            showToast('Renovação falhou', { spinner: false, timeout: 3500 });
          } else {
            // Show a short failure message and then link to login
            alert('Renovação falhou. Por favor, faça login novamente.');
            window.location.href = '/app/templates/git-course/login.html';
          }
          return false;
        }
      }

      try {
        const token = localStorage.getItem('access_token');
        if (token && isTokenValid(token)) {
          window.location.replace('/app/templates/git-course/1a-prefacio.html');
        } else {
          // Token is missing or expired -> show UI; do not auto-remove refresh_token here
          const hasRefresh = !!localStorage.getItem('refresh_token');
          renderExpiredUI(hasRefresh);
          // If a refresh token exists, attempt a silent refresh once automatically.
          // This keeps the manual "Tentar renovar token" button for the user while
          // attempting to recover the session automatically when possible.
          if (hasRefresh) {
            // Delay briefly to allow the UI to render and avoid race conditions.
            setTimeout(() => {
              // silent=true => don't show alerts or redirect to login on failure
              attemptRefresh(true);
            }, 600);
          }
        }
      } catch (e) {
        try { localStorage.removeItem('access_token'); } catch (__) {}
        window.location.replace('/landing.html');
      }
    })();
  </script>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; margin-top: 20vh;">
  <p>Entrando...</p>
  <p>
    Se não redirecionar automaticamente:
    <a href="/landing.html">Landing</a> |
    <a href="/app/templates/git-course/login.html">Login</a>
  </p>
</body>
</html>
