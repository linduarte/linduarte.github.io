<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Entrando...</title>
  <script>
    // Client-side token validation: parse a JWT in localStorage.access_token and check `exp` claim.
    // If expired, show a small UI to let the user login or attempt a refresh using a `refresh_token`.
    (function () {
      function base64UrlDecode(input) {
        // Replace url-safe chars and add padding
        input = input.replace(/-/g, '+').replace(/_/g, '/');
        const pad = input.length % 4;
        if (pad === 2) input += '==';
        else if (pad === 3) input += '=';
        else if (pad !== 0) return null;
        try {
          return decodeURIComponent(escape(atob(input)));
        } catch (e) {
          try {
            return atob(input);
          } catch (e2) {
            return null;
          }
        }
      }

      function parseJwt(token) {
        if (!token) return null;
        const parts = token.split('.');
        if (parts.length < 2) return null;
        const payload = base64UrlDecode(parts[1]);
        if (!payload) return null;
        try {
          return JSON.parse(payload);
        } catch (e) {
          return null;
        }
      }

      function isTokenValid(token) {
        const payload = parseJwt(token);
        if (!payload) return false;
        // If `exp` exists, check expiry (exp is seconds since epoch)
        if (payload.exp && typeof payload.exp === 'number') {
          const now = Math.floor(Date.now() / 1000);
          return payload.exp > now + 5; // 5s leeway
        }
        // No exp claim: consider it invalid (safer)
        return false;
      }

      function renderExpiredUI(hasRefresh) {
        document.body.innerHTML = '';
        const container = document.createElement('div');
        container.style.fontFamily = 'Arial, sans-serif';
        container.style.maxWidth = '520px';
        container.style.margin = '10vh auto';
        container.style.padding = '20px';
        container.style.border = '1px solid #e6e6e6';
        container.style.borderRadius = '6px';
        container.style.textAlign = 'center';

        const h = document.createElement('h2');
        h.textContent = 'Sessão expirada';
        container.appendChild(h);

        const p = document.createElement('p');
        p.textContent = 'Sua sessão expirou. Faça login para continuar ou tente renovar o token se disponível.';
        container.appendChild(p);

        const btnLogin = document.createElement('button');
        btnLogin.textContent = 'Login';
        btnLogin.style.margin = '8px';
        btnLogin.onclick = function () { window.location.href = '/app/templates/git-course/login.html'; };
        container.appendChild(btnLogin);

        if (hasRefresh) {
          const btnRefresh = document.createElement('button');
          btnRefresh.textContent = 'Tentar renovar token';
          btnRefresh.style.margin = '8px';
          btnRefresh.onclick = function () {
            attemptRefresh();
            btnRefresh.disabled = true;
            btnRefresh.textContent = 'Tentando...';
          };
          container.appendChild(btnRefresh);
        }

        const note = document.createElement('p');
        note.style.marginTop = '12px';
        note.style.fontSize = '13px';
        note.style.color = '#666';
        note.textContent = 'Se a renovação falhar, faça login novamente.';
        container.appendChild(note);

        document.body.appendChild(container);
      }

      async function attemptRefresh(silent = false) {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) return false;
        try {
          // Example refresh endpoint — your backend would need to provide this.
          const resp = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken })
          });

          if (!resp.ok) throw new Error('refresh-failed');
          const data = await resp.json();
          if (data && data.access_token) {
            localStorage.setItem('access_token', data.access_token);
            if (data.refresh_token) localStorage.setItem('refresh_token', data.refresh_token);
            // Redirect to prefácio
            window.location.replace('/app/templates/git-course/1a-prefacio.html');
            return true;
          }
          return false;
        } catch (e) {
          // Refresh failed — either fail silently or fall back to login
          try { localStorage.removeItem('access_token'); } catch (__) {}
          try { localStorage.removeItem('refresh_token'); } catch (__) {}
          if (!silent) {
            // Show a short failure message and then link to login
            alert('Renovação falhou. Por favor, faça login novamente.');
            window.location.href = '/app/templates/git-course/login.html';
          }
          return false;
        }
      }

      try {
        const token = localStorage.getItem('access_token');
        if (token && isTokenValid(token)) {
          window.location.replace('/app/templates/git-course/1a-prefacio.html');
        } else {
          // Token is missing or expired -> show UI; do not auto-remove refresh_token here
          const hasRefresh = !!localStorage.getItem('refresh_token');
          renderExpiredUI(hasRefresh);
          // If a refresh token exists, attempt a silent refresh once automatically.
          // This keeps the manual "Tentar renovar token" button for the user while
          // attempting to recover the session automatically when possible.
          if (hasRefresh) {
            // Delay briefly to allow the UI to render and avoid race conditions.
            setTimeout(() => {
              // silent=true => don't show alerts or redirect to login on failure
              attemptRefresh(true);
            }, 600);
          }
        }
      } catch (e) {
        try { localStorage.removeItem('access_token'); } catch (__) {}
        window.location.replace('/landing.html');
      }
    })();
  </script>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; margin-top: 20vh;">
  <p>Entrando...</p>
  <p>
    Se não redirecionar automaticamente:
    <a href="/landing.html">Landing</a> |
    <a href="/app/templates/git-course/login.html">Login</a>
  </p>
</body>
</html>
