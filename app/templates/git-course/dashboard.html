<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Git Course</title>
  <link rel="stylesheet" href="/app/static/css/git-course-c.css">
  <link rel="stylesheet" href="/app/static/css/dashboard.css">
</head>

<body>

  <!-- MENU LATERAL -->
  <div class="sidebar">
    <h2>Git Course</h2>
    <ul>
        <li><a href="/dashboard.html">üè† Dashboard</a></li>
        <li><a href="/progress.html">üìä Progresso</a></li>
        <li id="menuContinue">‚è≠ Continuar</li>
        <li id="menuLastTopic">üìå √öltimo t√≥pico</li>
        <li id="menuLogout">üö™ Sair</li>
    </ul>
  </div>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="dashboard-container">
    <h1>Bem-vindo ao Git Course!</h1>
    <p id="welcomeMessage">Carregando...</p>

    <!-- CARD DE PROGRESSO -->
    <div id="progressCard" class="progress-card">
        <h3>Seu Progresso</h3>
        <div id="progressCardContent">Carregando...</div>

        <div class="progress-bar">
            <div id="progressBarFill" class="progress-bar-fill"></div>
        </div>

        <button type="button" id="btnContinueCard" class="progress-btn">
            Continuar de onde parei ‚Üí
        </button>
    </div>

    <!-- PR√ìXIMO T√ìPICO -->
    <div id="nextTopicCard" class="info-card"></div>

    <!-- √öLTIMO T√ìPICO -->
    <div id="lastTopicCard" class="info-card"></div>

  </div>

  <script src="/app/static/js/config.js"></script>
  <script>
    const token = localStorage.getItem('access_token');
    const welcome = document.getElementById('welcomeMessage');

    if (!token) {
      window.location.href = "login.html";
    } else {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const username = payload.sub || "Usu√°rio";
        welcome.textContent = `Ol√°, ${username}! üöÄ Pronto para continuar seus estudos?`;
      } catch {
        welcome.textContent = "Bem-vindo!";
      }
    }

    // LOGOUT
    document.getElementById('menuLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // CARD DE PROGRESSO
    async function loadDashboardProgress() {
      const cardContent = document.getElementById("progressCardContent");
      const barFill = document.getElementById("progressBarFill");

      try {
        const resp = await fetch(`${API_URL}/progress/summary`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await resp.json();

        cardContent.innerHTML = `
            <b>${data.completion_rate}% conclu√≠do</b><br>
            ${data.completed_topics} de ${data.total_topics} t√≥picos finalizados
        `;

        barFill.style.width = data.completion_rate + "%";

      } catch (e) {
        cardContent.innerHTML = "Erro ao carregar progresso.";
      }
    }

    // PR√ìXIMO T√ìPICO
    async function loadNextTopic() {
      const nextCard = document.getElementById("nextTopicCard");

      const topicsResp = await fetch(`${API_URL}/topics/`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const topics = await topicsResp.json();

      const progressResp = await fetch(`${API_URL}/progress/`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const progress = await progressResp.json();

      const completedIds = progress.filter(p => p.completed).map(p => p.topic_id);

      const nextTopic = topics.find(t => !completedIds.includes(t.id));

      if (nextTopic) {
        nextCard.innerHTML = `
          <h3>Pr√≥ximo t√≥pico recomendado</h3>
          <p>${nextTopic.chapter}. ${nextTopic.title}</p>
          <button onclick="window.location.href='/topic/${nextTopic.id}'">Ir para o t√≥pico ‚Üí</button>
        `;
      } else {
        nextCard.innerHTML = `<h3>Voc√™ concluiu todos os t√≥picos! üéâ</h3>`;
      }
    }

    // √öLTIMO T√ìPICO
    function loadLastTopic() {
      const lastCard = document.getElementById("lastTopicCard");
      const last = localStorage.getItem("last_topic");

      if (!last) {
        lastCard.innerHTML = `<h3>Nenhum t√≥pico acessado ainda.</h3>`;
        return;
      }

      lastCard.innerHTML = `
        <h3>√öltimo t√≥pico acessado</h3>
        <button onclick="window.location.href='/topic/${last}'">Retomar ‚Üí</button>
      `;
    }

    // BOT√ÉO "CONTINUAR"
    document.getElementById("btnContinueCard").addEventListener("click", () => {
      const last = localStorage.getItem("last_topic");
      if (last) {
        window.location.href = `/topic/${last}`;
      } else {
        loadNextTopic().then(() => {
          const next = document.querySelector("#nextTopicCard button");
          if (next) next.click();
        });
      }
    });

    // MENU LATERAL: CONTINUAR
    document.getElementById("menuContinue").addEventListener("click", () => {
      document.getElementById("btnContinueCard").click();
    });

    // MENU LATERAL: √öLTIMO T√ìPICO
    document.getElementById("menuLastTopic").addEventListener("click", () => {
      const last = localStorage.getItem("last_topic");
      if (last) window.location.href = `/topic/${last}`;
      else alert("Nenhum t√≥pico acessado ainda.");
    });

    // CARREGAR TUDO
    loadDashboardProgress();
    loadNextTopic();
    loadLastTopic();

  </script>
</body>
</html>
