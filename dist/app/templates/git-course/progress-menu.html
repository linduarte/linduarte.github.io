<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<title>Menu de Progresso</title>
<link href="/app/static/css/style.css" rel="stylesheet"/>
<link href="/app/static/css/common-styles.css" rel="stylesheet"/>
<link href="/app/static/css/git-course.css" rel="stylesheet"/>
<link href="/app/static/css/footer-course.css" rel="stylesheet"/>
<style>
        body {
            background: url('/app/static/images/waves.webp') center/cover no-repeat fixed;
            font-family: 'Victor Mono', monospace;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
            margin: 40px auto;
            padding: 40px;
            max-width: 900px;
        }
    </style>
<script src="/app/static/js/config.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('access_token');
        if (!token) {
            // redirect to site entry (landing.html) when not authenticated
            window.location.href = '/landing.html';
            return;
        }
        const logoutBtn = document.getElementById('logoutButton');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('access_token');
                window.location.href = '/landing.html';
            });
        }
    });
    </script>
</head>
<body>
<div class="container">
<header class="header">
<h1>Menu de Progresso do Curso Git</h1>
</header>
<nav class="progress-nav">
<button class="nav-btn" onclick="showSection('summary')" type="button">Resumo</button>
<button class="nav-btn" onclick="showSection('list')" type="button">Listar Progresso</button>
<button class="nav-btn" onclick="showSection('create')" type="button">Criar Progresso</button>
<button class="nav-btn" onclick="showSection('update')" type="button">Atualizar Progresso</button>
<button class="nav-btn" onclick="showSection('delete')" type="button">Deletar Progresso</button>
</nav>
<div class="content-section" id="section-summary">
<h2>Resumo do Progresso</h2>
<div class="progress-summary">Carregando...</div>
</div>
<div class="content-section" id="section-list" style="display: none;">
<h2>Lista de Progresso</h2>
<div class="progress-list">Carregando...</div>
</div>
<div class="content-section" id="section-create" style="display: none;">
<h2>Registrar Novo Progresso</h2>
<form class="progress-form" id="formCreate">
<label>Tópico ID: <input name="topic_id" required="" type="number"/></label>
<label>Concluído:
                    <select name="completed">
<option value="true">Sim</option>
<option value="false">Não</option>
</select>
</label>
<label>Feedback: <textarea name="feedback"></textarea></label>
<button class="submit-btn" type="submit">Registrar</button>
</form>
<div class="result-message" id="resultCreate"></div>
</div>
<div class="content-section" id="section-update" style="display: none;">
<h2>Atualizar Progresso</h2>
<form class="progress-form" id="formUpdate">
<label>ID do Progresso: <input name="progress_id" required="" type="number"/></label>
<label>Concluído:
                    <select name="completed">
<option value="true">Sim</option>
<option value="false">Não</option>
</select>
</label>
<label>Feedback: <textarea name="feedback"></textarea></label>
<button class="submit-btn" type="submit">Atualizar</button>
</form>
<div class="result-message" id="resultUpdate"></div>
</div>
<div class="content-section" id="section-delete" style="display: none;">
<h2>Deletar Progresso</h2>
<form class="progress-form" id="formDelete">
<label>ID do Progresso: <input name="progress_id" required="" type="number"/></label>
<button class="submit-btn delete-btn" type="submit">Deletar</button>
</form>
<div class="result-message" id="resultDelete"></div>
</div>
<footer class="footer">
<a class="back-link" href="/landing.html">Voltar ao Curso</a>
<a class="back-link" href="dashboard.html" style="margin-left:12px;">Dashboard</a>
<form class="logout-form" style="display: inline-block; margin-left: 20px;">
<button class="logout-button" id="logoutButton" type="button">Logout</button>
</form>
</footer>
</div>
<script>
        function requireToken() {
            const token = localStorage.getItem("access_token");
            if(!token) {
                alert("Sessão não encontrada. Faça login.");
                window.location.href = "login.html";
                return null;
            }
            return token;
        }

        function showSection(section) {
            ["summary","list","create","update","delete"].forEach(s => {
                const el = document.getElementById(`section-${s}`);
                if (el) el.style.display = s === section ? "block" : "none";
            });
            if(section === "summary") fetchSummary();
            if(section === "list") fetchList();
        }

        async function fetchSummary() {
            const token = requireToken(); if(!token) return;
            const box = document.getElementById("section-summary");
            box.innerHTML = "Carregando...";
            try {
                const resp = await apiCall("/progress/summary");
                const data = await resp.json();
                box.innerHTML =
                  `<b>Total:</b> ${data.total}<br>
                   <b>Concluídos:</b> ${data.concluidos}<br>
                   <b>Pendentes:</b> ${data.pendentes}<br>
                   <b>Tópicos concluídos:</b> ${data.completados?.length ? data.completados.join(", ") : "Nenhum"}`;
            } catch(e) { box.innerHTML = "Erro ao carregar resumo."; console.error(e); }
        }

        async function fetchList() {
            const token = requireToken(); if(!token) return;
            const box = document.getElementById("section-list");
            box.innerHTML = "Carregando...";
            try {
                const resp = await apiCall("/progress");
                const data = await resp.json();
                if(!data.length) { box.innerHTML = "Nenhum progresso registrado."; return; }
                box.innerHTML = `<ul>${data.map(p =>
                    `<li>ID: ${p.id}, Tópico: ${p.topic_id}, Concluído: ${p.completed}, Feedback: ${p.feedback || "-"}</li>`
                ).join("")}</ul>`;
            } catch(e) { box.innerHTML = "Erro ao carregar lista."; console.error(e); }
        }

        document.getElementById("formCreate")?.addEventListener("submit", async e => {
            e.preventDefault();
            const token = requireToken(); if(!token) return;
            const f = e.target;
            const body = {
                topic_id: parseInt(f.topic_id.value),
                completed: f.completed.value === "true",
                feedback: f.feedback.value
            };
            const out = document.getElementById("resultCreate");
            out.textContent = "Enviando...";
            try {
                const resp = await apiCall("/progress", {
                    method: "POST",
                    body: JSON.stringify(body)
                });
                const data = await resp.json();
                out.textContent = resp.ok ? "Progresso registrado!" : (data.detail || "Erro");
            } catch(e){ out.textContent = "Erro de rede."; console.error(e); }
        });

        document.getElementById("formUpdate")?.addEventListener("submit", async e => {
            e.preventDefault();
            const token = requireToken(); if(!token) return;
            const f = e.target;
            const body = {
                completed: f.completed.value === "true",
                feedback: f.feedback.value
            };
            const id = f.progress_id.value;
            const out = document.getElementById("resultUpdate");
            out.textContent = "Atualizando...";
            try {
                const resp = await apiCall(`/progress/${id}`, {
                    method: "PUT",
                    body: JSON.stringify(body)
                });
                const data = await resp.json();
                out.textContent = resp.ok ? "Progresso atualizado!" : (data.detail || "Erro");
            } catch(e){ out.textContent = "Erro de rede."; console.error(e); }
        });

        document.getElementById("formDelete")?.addEventListener("submit", async e => {
            e.preventDefault();
            const token = requireToken(); if(!token) return;
            const f = e.target;
            const id = f.progress_id.value;
            const out = document.getElementById("resultDelete");
            out.textContent = "Removendo...";
            try {
                const resp = await apiCall(`/progress/${id}`, { method: "DELETE" });
                out.textContent = resp.ok ? "Progresso deletado!" : "Erro ao deletar";
            } catch(e){ out.textContent = "Erro de rede."; console.error(e); }
        });

        // Default view
        showSection("summary");
    </script>
</body>
</html>
